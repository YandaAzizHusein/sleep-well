<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Hasil Prediksi Tidur • SleepWell AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="img/logo-sinyal-tenang.png"/>
  <style>
    body { margin:0; font-family:'Segoe UI','Inter',Arial,sans-serif; background:linear-gradient(135deg,#e0e7ff 0%,#f6dfff 100%); min-height:100vh;}
    .wrap {display:flex;align-items:center;justify-content:center;min-height:100vh;}
    .card {
      background:#fff; max-width:430px; width:100%; border-radius:1.6rem;
      box-shadow:0 8px 40px 0 rgba(103,81,239,0.13);
      padding:38px 26px 26px 26px; margin: 36px 0; display:flex;flex-direction:column;gap:18px;animation:fadein .6s;
    }
    @keyframes fadein { from{opacity:0;transform:translateY(30px);} to{opacity:1;transform:none;}}
    .title {font-size:1.3rem;font-weight:800;color:#2563eb;margin-bottom:2px;}
    .sub {font-size:1rem;font-weight:600;color:#888;margin-bottom:7px;}
    .result-box {background:#f7f8fd;border-radius:10px;padding:14px 16px;font-size:1.12rem;color:#232;}
    .row {margin:7px 0;}
    .label {color:#888;font-weight:600;}
    .value {font-weight:700;}
    .btn {margin-top:16px;background:linear-gradient(90deg,#6751ef 30%,#2563eb 100%);
      color:#fff;border:none;font-size:1.13rem;font-weight:700;
      border-radius:1.1em;padding:1em 0;cursor:pointer;width:100%;
      transition:background .17s,transform .13s,box-shadow .13s;}
    .btn:hover {background:linear-gradient(90deg,#2563eb 10%,#6751ef 100%);transform:translateY(-1.5px) scale(1.015);}
    .alert {text-align:center;color:#e11d48;background:#fff1f2;border:1.2px solid #ffe4e6;
      border-radius:8px;padding:8px 12px;margin:4px 0 8px 0;font-size:.98rem;font-weight:500;display:none;}
    .loader {text-align:center;color:#2563eb;font-weight:600;margin:8px 0;display:none;}
    @media(max-width:600px){.card{max-width:98vw;padding:18px 4vw 16px 4vw;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">Hasil Prediksi Tidur</div>
      <div class="sub" id="profileBox"></div>
      <div class="result-box" id="predictionResult">
        <!-- Hasil prediksi tampil di sini -->
      </div>
      <div class="loader" id="loader">⏳ Mengupdate hasil prediksi...</div>
      <div class="alert" id="alertMsg"></div>
      <button class="btn" onclick="window.location.href='riwayat.html'">Lihat Riwayat & Grafik</button>
      <button class="btn" style="background:#f3f5fb;color:#2563eb;margin-top:2px;" onclick="window.location.href='main-menu.html'">Kembali ke Menu</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = 'https://vnbqtnhcxlhygfajoulf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuYnF0bmhjeGxoeWdmYWpvdWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3MjEwOTQsImV4cCI6MjA2NTI5NzA5NH0.iFEHsnjgufQuZ6kcaH1gtNT9qyNFfCu8JuxW_clgKRc';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let sleepInput = {};
    let sleep_data_id = null;

    function showLoader(show, msg) {
      document.getElementById("loader").style.display = show ? "block" : "none";
      if (msg) document.getElementById("loader").innerText = msg;
    }
    function showAlert(msg) {
      const el = document.getElementById("alertMsg");
      el.style.display = "block"; el.innerText = msg;
    }
    function hideAlert() { document.getElementById("alertMsg").style.display = "none"; }

    function tampilProfil() {
      const p = sleepInput;
      document.getElementById("profileBox").innerHTML =
        `<span class="label">Nama:</span> <span class="value">${p.name || '-'}</span> | 
         <span class="label">Gender:</span> <span class="value">${p.gender || '-'}</span> | 
         <span class="label">Umur:</span> <span class="value">${p.age || '-'}</span> | 
         <span class="label">Pekerjaan:</span> <span class="value">${p.occupation || '-'}</span> | 
         <span class="label">BMI:</span> <span class="value">${p.bmi_category || '-'}</span>`;
    }

    async function runPredictionAndUpdate() {
      // 1. Ambil data dari sessionStorage
      try {
        sleepInput = JSON.parse(sessionStorage.getItem("sleep_input") || "{}");
        sleep_data_id = sleepInput.sleep_data_id;
      } catch { showAlert("Gagal membaca data input!"); return; }

      tampilProfil();

      // 2. [SIMULASI] Hasil prediksi dummy, ganti dengan hasil model kamu jika sudah live
      const predictedQuality = Math.floor(Math.random()*30)+70;   // ex: 70-99
      const predictedDuration = (Math.random()*2+6).toFixed(1);   // ex: 6.0-8.0 jam
      const predictedDisorder = predictedQuality < 75 ? "Insomnia Ringan" : (predictedQuality < 85 ? "Tidur Kurang" : "Normal");

      // 3. Tampilkan di halaman
      document.getElementById("predictionResult").innerHTML =
        `<div class="row"><span class="label">Kualitas Tidur:</span> <span class="value">${predictedQuality} / 100</span></div>
         <div class="row"><span class="label">Durasi Tidur:</span> <span class="value">${predictedDuration} jam</span></div>
         <div class="row"><span class="label">Gangguan Tidur:</span> <span class="value">${predictedDisorder}</span></div>`;

      // 4. Update ke Supabase
      showLoader(true, "⏳ Mengupdate hasil prediksi...");
      hideAlert();
      try {
        const { error } = await supabase.from('sleep_data')
          .update({
            quality_of_sleep: predictedQuality,
            sleep_duration: predictedDuration,
            sleep_disorder: predictedDisorder
          })
          .eq('id', sleep_data_id);
        showLoader(false);
        if (error) showAlert("Gagal update hasil prediksi: " + error.message);
      } catch (err) {
        showLoader(false);
        showAlert("Gagal update data: " + (err.message || err));
      }
    }

    // Jalankan prediksi dan update setelah halaman siap
    window.onload = runPredictionAndUpdate;
  </script>
</body>
</html>
